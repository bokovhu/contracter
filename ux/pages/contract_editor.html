<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Project Contract Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div id="root"></div>
    <script src="https://unpkg.com/bootstrap@5.3.2/dist/js/bootstrap.bundle.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="/scripts/lib-contact-book.js"></script>
    <script src="/scripts/lib-web3-init.js"></script>

    <script type="text/babel">

        class ContractEditor extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    contract: JSON.parse(localStorage.getItem('contracter.contractEditorContract')) || {
                        title: '',
                        paragraphs: []
                    }
                };
            }

            handleTitleChange = (event) => {
                this.setState({
                    contract: {
                        ...this.state.contract,
                        title: event.target.value
                    }
                });
            };

            handleParagraphTitleChange = (index, event) => {
                const paragraphs = [...this.state.contract.paragraphs];
                paragraphs[index].title = event.target.value;
                this.setState({
                    contract: {
                        ...this.state.contract,
                        paragraphs
                    }
                });
            };

            handleProvisionChange = (paragraphIndex, provisionIndex, field, value) => {
                const paragraphs = [...this.state.contract.paragraphs];
                paragraphs[paragraphIndex].provisions[provisionIndex].payload[field] = value;
                this.setState({
                    contract: {
                        ...this.state.contract,
                        paragraphs
                    }
                });
            };

            addParagraph = () => {
                this.setState({
                    contract: {
                        ...this.state.contract,
                        paragraphs: [
                            ...this.state.contract.paragraphs,
                            {
                                title: '',
                                provisions: []
                            }
                        ]
                    }
                });
            };

            addProvision = (paragraphIndex, type) => {
                const paragraphs = [...this.state.contract.paragraphs];
                const newProvision = {
                    type: type,
                    payload: {
                        notes: ''
                    }
                };
                if (type === 'REQUIRE_DEPOSIT' || type === 'CREATE_REWARD') {
                    newProvision.payload.amount = 0;
                }
                if (type === 'REQUIRE_DEPOSIT' || type === 'REQUIRE_SIGNATURE') {
                    newProvision.payload.signer = '';
                }
                paragraphs[paragraphIndex].provisions.push(newProvision);
                this.setState({
                    contract: {
                        ...this.state.contract,
                        paragraphs
                    }
                });
            };

            saveContract = () => {
                localStorage.setItem('contracter.contractEditorContract', JSON.stringify(this.state.contract));
                alert('Contract saved!');
            };

            renderProvisionInput = (provision, paragraphIndex, provisionIndex) => {
                switch (provision.type) {
                    case 'REQUIRE_DEPOSIT':
                        return (
                            <>
                                <input
                                    type="text"
                                    className="form-control mb-2"
                                    value={provision.payload.depositor}
                                    onChange={(e) => this.handleProvisionChange(paragraphIndex, provisionIndex, 'depositor', e.target.value)}
                                    placeholder="Depositor"
                                />
                                <input
                                    type="number"
                                    className="form-control mb-2"
                                    value={provision.payload.amount}
                                    onChange={(e) => this.handleProvisionChange(paragraphIndex, provisionIndex, 'amount', e.target.value)}
                                    placeholder="Amount"
                                />
                                <input
                                    type="text"
                                    className="form-control mb-2"
                                    value={provision.payload.notes}
                                    onChange={(e) => this.handleProvisionChange(paragraphIndex, provisionIndex, 'notes', e.target.value)}
                                    placeholder="Notes"
                                />
                            </>
                        );
                    case 'REQUIRE_SIGNATURE':
                        return (
                            <>
                                <input
                                    type="text"
                                    className="form-control mb-2"
                                    value={provision.payload.signer}
                                    onChange={(e) => this.handleProvisionChange(paragraphIndex, provisionIndex, 'signer', e.target.value)}
                                    placeholder="Signer"
                                />
                                <input
                                    type="text"
                                    className="form-control mb-2"
                                    value={provision.payload.notes}
                                    onChange={(e) => this.handleProvisionChange(paragraphIndex, provisionIndex, 'notes', e.target.value)}
                                    placeholder="Notes"
                                />
                            </>
                        );
                    case 'CREATE_REWARD':
                        return (
                            <>
                                <input
                                    type="number"
                                    className="form-control mb-2"
                                    value={provision.payload.reward}
                                    onChange={(e) => this.handleProvisionChange(paragraphIndex, provisionIndex, 'reward', e.target.value)}
                                    placeholder="Reward"
                                />
                                <input
                                    type="text"
                                    className="form-control mb-2"
                                    value={provision.payload.notes}
                                    onChange={(e) => this.handleProvisionChange(paragraphIndex, provisionIndex, 'notes', e.target.value)}
                                    placeholder="Notes"
                                />
                            </>
                        );
                    default:
                        return null;
                }
            };

            renderParagraph = (paragraph, index) => {
                return (
                    <div key={index} className="card mb-3">
                        <div className="card-header">
                            <input
                                type="text"
                                className="form-control"
                                value={paragraph.title}
                                onChange={(e) => this.handleParagraphTitleChange(index, e)}
                                placeholder="Paragraph Title"
                            />
                        </div>
                        <div className="card-body">
                            {paragraph.provisions.map((provision, provisionIndex) =>
                                this.renderProvisionInput(provision, index, provisionIndex)
                            )}
                            <button className="btn btn-outline-primary mt-2" onClick={() => this.addProvision(index, 'REQUIRE_DEPOSIT')}>Add Require Deposit</button>
                            <button className="btn btn-outline-secondary mt-2 ms-2" onClick={() => this.addProvision(index, 'REQUIRE_SIGNATURE')}>Add Require Signature</button>
                            <button className="btn btn-outline-success mt-2 ms-2" onClick={() => this.addProvision(index, 'CREATE_REWARD')}>Add Create Reward</button>
                        </div>
                    </div>
                );
            };

            render() {
                return (
                    <div className="container my-4">
                        <h2>Contract Editor</h2>
                        <input
                            type="text"
                            className="form-control mb-3"
                            value={this.state.contract.title}
                            onChange={this.handleTitleChange}
                            placeholder="Contract Title"
                        />
                        {this.state.contract.paragraphs.map(this.renderParagraph)}
                        <button className="btn btn-primary" onClick={this.addParagraph}>Add Paragraph</button>
                        <button className="btn btn-success float-end" onClick={this.saveContract}>Save Contract</button>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContractEditor />);
    </script>
</body>

</html>
